datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

model CareHome {
  id        String   @id @default(uuid())
  name      String
  region    String  @default("UK South")
  isActive  Boolean  @default(true)
  residents Resident[]
  visits    Visit[]
  invoices  Invoice[]
  careHqResidents CareHqResident[]
  residentConsents ResidentConsent[]
  saleItems SaleItem[]
  newspaperOrders NewspaperOrder[]
  visitSheets VisitSheet[]
  homeRoles UserHomeRole[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Supplier {
  id          String              @id @default(uuid())
  name        String
  serviceType String              @db.VarChar(32)
  email       String?
  phone       String?
  defaultRate Decimal             @db.Decimal(10, 2)
  isActive    Boolean             @default(true)
  visits      Visit[]
  consents    Consent[]
  invoices    Invoice[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
}

model Resident {
  id         String   @id @default(uuid())
  careHomeId String
  careHome   CareHome @relation(fields: [careHomeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  firstName  String
  lastName   String
  dob        DateTime?
  isActive   Boolean  @default(true)
  consents   Consent[]
  visitItems VisitItem[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model CareHqResident {
  id              String   @id @default(uuid()) @db.NVarChar(191)
  careHomeId      String?
  careHomeName    String
  careHqLocationId String
  careHqRoomId    String   @unique @db.NVarChar(191)
  roomNumber      String   @db.NVarChar(191)
  fullName        String?  @db.NVarChar(191)
  accountCode     String?  @db.NVarChar(191)
  serviceUserId   String?  @db.NVarChar(191)
  isVacant        Boolean  @default(false)
  lastSyncedAt    DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  careHome        CareHome? @relation(fields: [careHomeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  residentConsents ResidentConsent[]
  saleItems       SaleItem[]
  newspaperOrders NewspaperOrder[]
}

model AppUser {
  id          String   @id @default(uuid())
  oid         String   @unique
  upn         String?  @unique
  displayName String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  homeRoles   UserHomeRole[]
}

model UserHomeRole {
  id         String   @id @default(uuid())
  userId     String
  careHomeId String
  role       String   @default("User") @db.VarChar(32)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       AppUser  @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  careHome   CareHome @relation(fields: [careHomeId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([userId, careHomeId])
}

model Vendor {
  id          String   @id @default(uuid())
  name        String
  accountRef  String   @unique
  defNomCode  String?  @db.VarChar(16)
  tradeContact String?
  address1    String?
  address2    String?
  address3    String?
  address4    String?
  address5    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  priceItems  PriceItem[]
  saleItems   SaleItem[]
  visitSheets VisitSheet[]
}

model PriceItem {
  id          String   @id @default(uuid())
  vendorId    String
  description String
  price       Decimal  @db.Decimal(10, 2)
  validFrom   DateTime?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  saleItems   SaleItem[]

  @@index([vendorId])
}

model ResidentConsent {
  id                   String   @id @default(uuid())
  careHomeId           String
  careHqResidentId     String? @db.NVarChar(191)
  roomNumber           String? @db.NVarChar(191)
  fullName             String? @db.NVarChar(191)
  accountCode          String? @db.NVarChar(191)
  serviceUserId        String? @db.NVarChar(191)
  sundryConsentReceived Boolean @default(false)
  newspapersConsent    Boolean @default(false)
  chiropodyConsent     Boolean @default(false)
  hairdressersConsent  Boolean @default(false)
  shopConsent          Boolean @default(false)
  otherConsent         Boolean @default(false)
  comments             String?
  chiropodyNote        String?
  shopNote             String?
  currentResident      Boolean @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  careHome             CareHome @relation(fields: [careHomeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  careHqResident        CareHqResident? @relation(fields: [careHqResidentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  attachments          ConsentAttachment[]

  @@unique([careHomeId, accountCode])
  @@index([careHomeId])
  @@index([careHqResidentId])
}

model ConsentAttachment {
  id                String   @id @default(uuid())
  residentConsentId String
  fileName          String
  fileUrl           String
  uploadedBy        String?
  uploadedAt        DateTime @default(now())
  residentConsent   ResidentConsent @relation(fields: [residentConsentId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([residentConsentId])
}

model SaleItem {
  id              String   @id @default(uuid())
  careHomeId      String
  careHqResidentId String @db.NVarChar(191)
  vendorId        String
  priceItemId     String?
  description     String
  price           Decimal  @db.Decimal(10, 2)
  date            DateTime
  invoiced        Boolean  @default(false)
  invoiceNumber   String?
  serviceUserId   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  careHome        CareHome @relation(fields: [careHomeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  careHqResident   CareHqResident @relation(fields: [careHqResidentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  vendor          Vendor   @relation(fields: [vendorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  priceItem       PriceItem? @relation(fields: [priceItemId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([careHomeId])
  @@index([vendorId])
  @@index([careHqResidentId])
}

model Newspaper {
  id               String   @id @default(uuid())
  title            String
  price            Decimal  @db.Decimal(10, 2)
  weekdayOrWeekend String?  @db.VarChar(16)
  sort             Int      @default(0)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  orders           NewspaperOrder[]

  @@unique([title])
}

model NewspaperOrder {
  id              String   @id @default(uuid())
  careHomeId      String
  careHqResidentId String @db.NVarChar(191)
  newspaperId     String
  itemTitle       String
  price           Decimal  @db.Decimal(10, 2)
  monday          Boolean  @default(false)
  tuesday         Boolean  @default(false)
  wednesday       Boolean  @default(false)
  thursday        Boolean  @default(false)
  friday          Boolean  @default(false)
  saturday        Boolean  @default(false)
  sunday          Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  careHome        CareHome @relation(fields: [careHomeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  careHqResident   CareHqResident @relation(fields: [careHqResidentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  newspaper       Newspaper @relation(fields: [newspaperId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([careHqResidentId, newspaperId])
  @@index([careHomeId])
}

model Consent {
  id                String        @id @default(uuid())
  residentId        String
  resident          Resident      @relation(fields: [residentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  supplierId        String
  supplier          Supplier      @relation(fields: [supplierId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  serviceType       String        @db.VarChar(32)
  consentGivenAt    DateTime
  consentExpiresAt  DateTime?
  notes             String?
  createdBy         String
  createdAt         DateTime      @default(now())
  status            String        @default("Active")
  visitItems        VisitItem[]
}

model Visit {
  id         String   @id @default(uuid())
  careHomeId String
  careHome   CareHome @relation(fields: [careHomeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  visitedAt  DateTime
  status     String   @default("Draft") @db.VarChar(16)
  createdBy  String
  createdAt  DateTime @default(now())
  lockedAt   DateTime?
  notes      String?
  items      VisitItem[]
  invoice    Invoice? @relation(fields: [invoiceId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  invoiceId  String?
}

model VisitSheet {
  id         String   @id @default(uuid())
  careHomeId String
  vendorId   String
  visitDate  DateTime
  status     String   @default("Draft") @db.VarChar(16)
  signedAt   DateTime?
  createdBy  String
  createdAt  DateTime @default(now())
  careHome   CareHome @relation(fields: [careHomeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  vendor     Vendor   @relation(fields: [vendorId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([careHomeId, vendorId, visitDate])
  @@index([careHomeId])
  @@index([vendorId])
}

model VisitItem {
  id            String   @id @default(uuid())
  visitId       String
  visit         Visit    @relation(fields: [visitId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  residentId    String
  resident      Resident @relation(fields: [residentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  description   String
  qty           Decimal  @db.Decimal(10, 2)
  unitPrice     Decimal  @db.Decimal(10, 2)
  vatRate       Decimal  @db.Decimal(5, 2)
  lineTotal     Decimal  @db.Decimal(12, 2)
  consentId     String?
  consent       Consent? @relation(fields: [consentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  invoiceItem   InvoiceItem?
}

model Invoice {
  id          String   @id @default(uuid())
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  careHomeId  String
  careHome    CareHome @relation(fields: [careHomeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  invoiceNo   String   @unique
  periodStart DateTime
  periodEnd   DateTime
  issuedAt    DateTime?
  subtotal    Decimal  @db.Decimal(12, 2)
  vatTotal    Decimal  @db.Decimal(12, 2)
  total       Decimal  @db.Decimal(12, 2)
  status      String   @default("Draft") @db.VarChar(16)
  items       InvoiceItem[]
  visits      Visit[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model InvoiceItem {
  id          String   @id @default(uuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  visitItemId String?  @unique
  visitItem   VisitItem? @relation(fields: [visitItemId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  description String
  qty         Decimal   @db.Decimal(10, 2)
  unitPrice   Decimal   @db.Decimal(10, 2)
  vatRate     Decimal   @db.Decimal(5, 2)
  lineTotal   Decimal   @db.Decimal(12, 2)
}

model AuditLog {
  id          String   @id @default(uuid())
  actorUpn    String
  action      String
  entityType  String
  entityId    String
  at          DateTime @default(now())
  detailsJson String?
}

