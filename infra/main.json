{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "4702608402601500800"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "aadTenantId": {
      "type": "string"
    },
    "webClientId": {
      "type": "string"
    },
    "apiAudience": {
      "type": "string",
      "defaultValue": "api://sundries-api"
    },
    "sqlAdminPassword": {
      "type": "securestring"
    },
    "deploymentPrincipalObjectId": {
      "type": "string"
    }
  },
  "variables": {
    "sqlAdminLogin": "sundriesadmin",
    "sqlServerName": "[toLower(format('sundriessql{0}', uniqueString(resourceGroup().id, 'sql')))]",
    "databaseName": "sundriesdb",
    "lawName": "[toLower(format('sundries-law-{0}', uniqueString(resourceGroup().id, 'law')))]",
    "aiName": "[toLower(format('sundries-ai-{0}', uniqueString(resourceGroup().id, 'ai')))]",
    "keyVaultName": "[toLower(format('sundries-kv-{0}', uniqueString(resourceGroup().id, 'kv')))]",
    "appPlanName": "sundries-plan-prod",
    "webAppName": "sundries-web-prod",
    "apiAppName": "sundries-api-prod",
    "sqlServerHostnameSuffix": "[environment().suffixes.sqlServerHostname]",
    "databaseConnectionString": "[format('Server=tcp:{0}.{1},1433;Initial Catalog={2};Persist Security Info=False;Encrypt=True;TrustServerCertificate=False;MultipleActiveResultSets=False;User ID={3};Password={4};', variables('sqlServerName'), variables('sqlServerHostnameSuffix'), variables('databaseName'), variables('sqlAdminLogin'), parameters('sqlAdminPassword'))]",
    "apiBaseUri": "[format('https://{0}.azurewebsites.net', variables('apiAppName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2022-10-01",
      "name": "[variables('lawName')]",
      "location": "[parameters('location')]",
      "properties": {
        "retentionInDays": 30
      },
      "sku": {
        "name": "PerGB2018"
      }
    },
    {
      "type": "Microsoft.Insights/components",
      "apiVersion": "2020-02-02",
      "name": "[variables('aiName')]",
      "location": "[parameters('location')]",
      "properties": {
        "Application_Type": "web",
        "Flow_Type": "Bluefield",
        "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('lawName'))]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('lawName'))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers",
      "apiVersion": "2022-08-01-preview",
      "name": "[variables('sqlServerName')]",
      "location": "[parameters('location')]",
      "properties": {
        "administratorLogin": "[variables('sqlAdminLogin')]",
        "administratorLoginPassword": "[parameters('sqlAdminPassword')]",
        "version": "12.0",
        "minimalTlsVersion": "1.2",
        "publicNetworkAccess": "Enabled"
      }
    },
    {
      "type": "Microsoft.Sql/servers/databases",
      "apiVersion": "2022-08-01-preview",
      "name": "[format('{0}/{1}', variables('sqlServerName'), variables('databaseName'))]",
      "location": "[parameters('location')]",
      "properties": {
        "readScale": "Disabled"
      },
      "sku": {
        "name": "S0",
        "tier": "Standard"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
      ]
    },
    {
      "type": "Microsoft.Sql/servers/firewallRules",
      "apiVersion": "2022-08-01-preview",
      "name": "[format('{0}/{1}', variables('sqlServerName'), 'AllowAzureServices')]",
      "properties": {
        "startIpAddress": "0.0.0.0",
        "endIpAddress": "0.0.0.0"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Sql/servers', variables('sqlServerName'))]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-12-01",
      "name": "[variables('keyVaultName')]",
      "location": "[parameters('location')]",
      "properties": {
        "sku": {
          "family": "A",
          "name": "standard"
        },
        "tenantId": "[tenant().tenantId]",
        "enableSoftDelete": true,
        "softDeleteRetentionInDays": 90,
        "enablePurgeProtection": false,
        "accessPolicies": [
          {
            "tenantId": "[tenant().tenantId]",
            "objectId": "[parameters('deploymentPrincipalObjectId')]",
            "permissions": {
              "secrets": [
                "get",
                "list",
                "set"
              ]
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2023-12-01",
      "name": "[format('{0}/{1}', variables('keyVaultName'), 'DatabaseConnectionString')]",
      "properties": {
        "value": "[variables('databaseConnectionString')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ]
    },
    {
      "type": "Microsoft.Web/serverfarms",
      "apiVersion": "2024-03-01",
      "name": "[variables('appPlanName')]",
      "location": "[parameters('location')]",
      "kind": "linux",
      "sku": {
        "name": "S1",
        "tier": "Standard",
        "capacity": 1
      },
      "properties": {
        "reserved": true
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2024-03-01",
      "name": "[variables('apiAppName')]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "SystemAssigned"
      },
      "kind": "app,linux",
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appPlanName'))]",
        "siteConfig": {
          "linuxFxVersion": "NODE|18-lts",
          "appSettings": [
            {
              "name": "WEBSITE_RUN_FROM_PACKAGE",
              "value": "1"
            },
            {
              "name": "APPINSIGHTS_CONNECTION_STRING",
              "value": "[listKeys(resourceId('Microsoft.Insights/components', variables('aiName')), '2020-02-02').connectionString]"
            },
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "[listKeys(resourceId('Microsoft.Insights/components', variables('aiName')), '2020-02-02').connectionString]"
            },
            {
              "name": "KEYVAULT_NAME",
              "value": "[variables('keyVaultName')]"
            },
            {
              "name": "DATABASE_URL",
              "value": "[format('@Microsoft.KeyVault(SecretUri={0})', reference(resourceId('Microsoft.KeyVault/vaults/secrets', variables('keyVaultName'), 'DatabaseConnectionString'), '2023-12-01').secretUriWithVersion)]"
            },
            {
              "name": "TENANT_ID",
              "value": "[parameters('aadTenantId')]"
            },
            {
              "name": "API_AUDIENCE",
              "value": "[parameters('apiAudience')]"
            },
            {
              "name": "LOG_LEVEL",
              "value": "Information"
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/components', variables('aiName'))]",
        "[resourceId('Microsoft.Web/serverfarms', variables('appPlanName'))]",
        "[resourceId('Microsoft.KeyVault/vaults/secrets', variables('keyVaultName'), 'DatabaseConnectionString')]",
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ]
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2024-03-01",
      "name": "[variables('webAppName')]",
      "location": "[parameters('location')]",
      "kind": "app,linux",
      "properties": {
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appPlanName'))]",
        "siteConfig": {
          "linuxFxVersion": "NODE|18-lts",
          "appSettings": [
            {
              "name": "WEBSITE_RUN_FROM_PACKAGE",
              "value": "1"
            },
            {
              "name": "APPINSIGHTS_CONNECTION_STRING",
              "value": "[listKeys(resourceId('Microsoft.Insights/components', variables('aiName')), '2020-02-02').connectionString]"
            },
            {
              "name": "VITE_API_BASE_URL",
              "value": "[variables('apiBaseUri')]"
            },
            {
              "name": "VITE_AAD_CLIENT_ID",
              "value": "[parameters('webClientId')]"
            },
            {
              "name": "VITE_AAD_TENANT_ID",
              "value": "[parameters('aadTenantId')]"
            },
            {
              "name": "VITE_API_AUDIENCE",
              "value": "[parameters('apiAudience')]"
            },
            {
              "name": "KEYVAULT_NAME",
              "value": "[variables('keyVaultName')]"
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/components', variables('aiName'))]",
        "[resourceId('Microsoft.Web/serverfarms', variables('appPlanName'))]",
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ]
    },
    {
      "type": "Microsoft.KeyVault/vaults/accessPolicies",
      "apiVersion": "2023-12-01",
      "name": "[format('{0}/{1}', variables('keyVaultName'), 'add-api-policy')]",
      "properties": {
        "accessPolicies": [
          {
            "tenantId": "[tenant().tenantId]",
            "objectId": "[reference(resourceId('Microsoft.Web/sites', variables('apiAppName')), '2024-03-01', 'full').identity.principalId]",
            "permissions": {
              "secrets": [
                "get",
                "list"
              ]
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', variables('apiAppName'))]",
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ]
    }
  ]
}